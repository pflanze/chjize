#!/bin/bash

set -euo pipefail
IFS=

cd /opt/chj/chjize

usage () {
    {
        echo "$0 [make options] [target(s)]"
        echo "  Runs the given targets."
        echo
        make -s -f targets.mk help
    } | less # --quit-if-one-screen
    exit 0
}

if [ $# -gt 0 ]; then
    if [ "$1" = "-h" -o "$1" = "--help" ]; then
        usage
    fi
fi


export MESSAGEBASE=/opt/chj/chjize/.messages
mkdir -p "$MESSAGEBASE"

make -f targets.mk "$@"

# If successful [or always?, but now keeping messages from
# unsuccessful runs around until a successful one, which is probably
# better], show the messages:

ruler () {
    printf '%q\n' --------------------------------------------------------------------
}

seen_msgs=0

while read msgfile; do
    ruler
    printf 'Messages from %q:\n' "$(printf '%q\n' "$msgfile" | sed 's/\./: /')"
    cat "$MESSAGEBASE/$msgfile"
    seen_msgs=1
done < <(ls "$MESSAGEBASE")

if [ "$seen_msgs" = 1 ]; then
    ruler
fi

# now that they have been shown, remove the messages:
rm -rf "$MESSAGEBASE"

