#!/bin/bash

set -euo pipefail
IFS=

source /opt/chj/chjize/lib/root-add-ssh.bash

usage () {
    echo "$0 uid"
    echo "  Copies over the authorized ssh keys of user uid (which must be numerical?)"
    echo "  to the root user's authorized keys file."
    echo "  Safe to call multiple times in parallel in the sense"
    echo "  that it will not destroy the old entries, but one of the"
    echo "  concurrent invocation's changes will be lost."
    exit 1
}

if [ $# -ne 1 ]; then
    usage
fi

presudouid=$1


from=$(uid_authorizedkeysfile "$presudouid")
to=$(uid_authorizedkeysfile 0)
if [ "$from" = "$to" ]; then
    echo "$0: odd, should not be identical, BUG?: '$from', '$to'"
    # Well, unless both users were really configured to have
    # the same dir, but that would be odd since
    # insecure/voiding sudo anyway.
    #do_nosudo_force # really?
    exit 1
else
    cleaned=$(mktemp)

    if [ -e "$to" ]; then
        # Remove entries from AWS
        01ok grep -v 'Please login as the user' < "$to" > "$cleaned"
        # keep backup, all of them due to concurrency, use file's inode
        # number for guaranteed conflict freedom
        ino=$(stat --printf '%i' "$to")
        ln "$to" "$to.$ino~" || true
    fi

    # Add entries from $from which are not in $cleaned
    tmp=$(mktemp)
    {
        cat "$from"
        echo
        cat "$cleaned"
        echo
    } > "$tmp"
    tmp2=$(mktemp)
    LANG=C sort -u < "$tmp" > "$tmp2"
    new=$(mktemp -p "$(dirname "$to")")
    egrep -v '^$' < "$tmp2" > "$new"
    # new is private, make it "normal"
    chmod a+r "$new"
    mv -f "$new" "$to"
fi

