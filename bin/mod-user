#!/bin/bash

set -euo pipefail
IFS=

backupbranchname=backup
url=https://github.com/pflanze/chj-home.git
dirname=chj-home

usage () {
    echo "$0"
    echo "  As the current user and in the current directory (which"
    echo "  should either be the user's home dir, or /etc/skel),"
    echo "  check out $url, move the"
    echo "  checkout's .git dir to ./, add the local state of the tracked files"
    echo "  into a branch named '$backupbranchname', then reset the files to"
    echo "  the versions from $url."
    exit 1
}

if [ $# -ne 0 ]; then
    usage
fi

export GIT_AUTHOR_NAME="chjize's mod-user"
export GIT_AUTHOR_EMAIL=${EMAIL-you@example.com}

set -x

git clone "$url"
mv "$dirname/.git" .
/opt/chj/bin/trash ./"$dirname"
/opt/chj/bin/mvnumber .gitignore .gitignore_global || true
git checkout .gitignore .gitignore_global
git add . && git commit -a -m "files before running chjize's $0"
/opt/chj/chjize/bin/checkout-latest-release
# ./home-init  -- NO, let user do that on first login (since it needs to ask questions)
